# Rare Disease Multi-Omics Reporter

## Overview

This project is a portfolio-style rare disease multi-omics pipeline that mimics a pharma-style analysis workflow. It takes three main inputs:

- a variant table (VCF-like TSV) for a patient  
- an RNA-seq counts matrix  
- a free-text phenotype description  

and produces a structured markdown report that combines:

- variant-level evidence (rule-based pathogenicity scores)  
- gene-level expression changes from a DESeq2 differential expression analysis  
- optional GO / pathway enrichment via clusterProfiler  
- a narrative summary generated by a large language model (LLM) or a safe fallback template  

This is a learning and portfolio project only – it is not a clinical decision-support tool.

## Dataset

The `data/` directory holds small synthetic example inputs:

- `example_variants.tsv`  
  - Simple TSV acting as a VCF-like table  
  - Expected columns:  
    - `chrom`, `pos`, `ref`, `alt`, `gene`, `consequence`, `af`

- `counts.tsv`  
  - Toy RNA-seq counts matrix with genes in rows and samples in columns  
  - Example columns:  
    - `control1`, `control2`, `treated1`, `treated2`

The example gene names are placeholders (e.g. `GENE1`, `GENE2`), so GO enrichment may not find real biological terms. With realistic gene IDs (SYMBOL or ENSEMBL), the same code can perform meaningful downstream analyses.

## Methods

The project is deliberately split across Python, R, and LLM components, similar to real-world rare disease and pharma pipelines.

### Python components (`src/rdmr/`)

- Command-line interface (`cli.py`, invoked via `run_report.py`)  
  - Arguments:
    - `--vcf` – path to a variant table (TSV; VCF-like)  
    - `--counts` – path to an RNA-seq counts matrix (TSV)  
    - `--phenotypes` – free-text phenotype description  
    - `--out` – path to the output markdown report  
  - Orchestrates the full pipeline (variants → expression → enrichment → report).

- Variant scoring (`variant_scoring.py`)  
  - Loads TSV with columns: `chrom`, `pos`, `ref`, `alt`, `gene`, `consequence`, `af`.  
  - Applies a simple rule-based pathogenicity score:
    - High-impact consequences (e.g. `stop_gained`, `frameshift_variant`, splice-site) receive higher scores.  
    - Medium-impact consequences (`missense_variant`, inframe events) receive moderate scores.  
    - Synonymous / intron / other consequences receive zero.  
    - Rarer variants (lower allele frequency `af`) receive additional points.  
  - Produces a `score` column and sorts variants from most to least suspicious.  
  - Writes `results/variants/scored_variants.tsv`.

- Pipeline orchestration (`cli.py`)  
  - Step 1: Score variants and save results.  
  - Step 2: Call R for DESeq2-based differential expression.  
  - Step 3: Call R for GO enrichment (if genes can be mapped).  
  - Step 4: Load results and generate a final markdown report via `llm_report.py`.

- LLM / report generation (`llm_report.py`)  
  - Loads:
    - top-N scored variants (e.g. top 5) from `scored_variants.tsv`  
    - DESeq2 results (e.g. from `deseq2_results.tsv`)  
  - Builds concise bullet summaries:
    - Variant summary – gene, genomic location, consequence, allele frequency, score.  
    - Expression summary – `baseMean` and log2 fold change.  
  - If `OPENAI_API_KEY` is set and the OpenAI client is available:
    - Calls a chat model (e.g. `gpt-4o-mini`) with a structured prompt.  
    - Asks for a short markdown report with sections:
      - Findings  
      - Supporting Evidence  
      - Limitations (research only)  
  - If no key is set or the call fails, generates a fallback template report summarising:
    - phenotype description  
    - top variants  
    - expression results  

The final markdown report is written to the path given by `--out` (e.g. `results/reports/patient_001_report.md`).

### R components (`R/`)

1. DESeq2 analysis – `01_deseq2_analysis.R`  

   - Performs a simplified but real DESeq2 analysis.  
   - Assumes:
     - `counts.tsv` has genes as rows and at least four samples as columns.  
     - First two columns are control samples; next two are treated samples.  
   - Workflow:
     - Reads the count matrix.  
     - Builds a `DESeqDataSet` with design `~ condition`.  
     - Uses gene-wise dispersion estimates (appropriate for very small toy datasets):
       - `estimateSizeFactors(dds)`  
       - `estimateDispersionsGeneEst(dds)`  
       - `dispersions(dds) <- mcols(dds)$dispGeneEst`  
       - `nbinomWaldTest(dds)`  
     - Extracts results:
       - `gene`, `baseMean`, `log2FoldChange`, `lfcSE`, `pvalue`, `padj`.  
     - Writes `results/expression/deseq2_results.tsv`.  
     - Generates a volcano plot (log2 fold change vs –log10 p-value):
       - Saved as `results/expression/volcano_deseq2.png`.

2. GO enrichment – `02_pathway_analysis.R`  

   - Uses clusterProfiler and org.Hs.eg.db for GO Biological Process (BP) enrichment.  
   - Steps:
     - Reads `deseq2_results.tsv`.  
     - Filters for differentially expressed genes using toy thresholds:
       - `padj < 0.05` and `|log2FoldChange| > 1`.  
     - Attempts to map gene IDs to ENTREZ IDs via `bitr(...)`.  
     - If mapping succeeds:
       - Runs `enrichGO()` on GO BP.  
       - Writes `results/expression/go_enrichment_BP.tsv`.  
       - Saves a barplot of top GO BP terms to `results/expression/go_bp_barplot.png`.  
     - If mapping fails (e.g. placeholder gene names), prints a message and exits gracefully.

## Setup

1. Clone the repository:

       git clone <this-repo-url>
       cd rare_disease_multiomics_reporter

2. Create and activate a Python virtual environment:

       python -m venv .venv
       source .venv/bin/activate          # Windows PowerShell: .venv\Scripts\Activate.ps1

3. Install Python dependencies:

       pip install -r requirements.txt

   Typical Python packages include:

   - pandas  
   - numpy  
   - scikit-learn  
   - openai  

4. Install R and Bioconductor packages (in an R session):

       if (!require("BiocManager", quietly = TRUE)) {
           install.packages("BiocManager")
       }

       BiocManager::install(c(
           "DESeq2",
           "clusterProfiler",
           "org.Hs.eg.db"
       ))

       install.packages("ggplot2")

5. Configure the OpenAI API key (optional, for LLM-generated summaries):

   - macOS / Linux:

         export OPENAI_API_KEY="your_real_openai_key_here"

   - Windows PowerShell:

         $Env:OPENAI_API_KEY="your_real_openai_key_here"

If the API key is not set, the pipeline still runs and produces a template report without LLM-generated text.

## How to Run

From the project root, run the full pipeline:

    python run_report.py \
      --vcf data/example_variants.tsv \
      --counts data/counts.tsv \
      --phenotypes "short stature, developmental delay" \
      --out results/reports/patient_001_report.md

This performs:

1. Variant scoring (Python)  
   - Reads `data/example_variants.tsv`.  
   - Computes rule-based pathogenicity scores.  
   - Writes `results/variants/scored_variants.tsv`.

2. Differential expression (R, DESeq2)  
   - Reads `data/counts.tsv`.  
   - Runs DESeq2 (gene-wise dispersions) comparing treated vs control.  
   - Writes `results/expression/deseq2_results.tsv`.  
   - Generates `results/expression/volcano_deseq2.png`.

3. GO enrichment (R, clusterProfiler)  
   - Reads `deseq2_results.tsv`.  
   - Filters for significant DE genes (toy thresholds).  
   - Attempts GO BP enrichment and writes:
     - `results/expression/go_enrichment_BP.tsv` (if successful)  
     - `results/expression/go_bp_barplot.png`  

4. Report generation (Python + optional LLM)  
   - Loads phenotype text, top variants, and DESeq2 results.  
   - If configured, calls an LLM for a concise research-style summary.  
   - Otherwise, writes a clear template report.  
   - Saves the report to `results/reports/patient_001_report.md`.

## Results

With the provided toy data, you can expect:

- Variant scoring output (`results/variants/scored_variants.tsv`):
  - High-impact, ultra-rare variants (e.g. stop_gained, frameshift_variant with very low `af`) ranked at the top.  
  - Synonymous or intron variants with low scores at the bottom.

- DESeq2 output (`results/expression/deseq2_results.tsv`):
  - Per-gene statistics including:
    - `baseMean` – average normalized expression  
    - `log2FoldChange` – treated vs control  
    - `pvalue` and `padj` – simple differential expression measures  
  - A volcano plot image: `results/expression/volcano_deseq2.png`.

- GO enrichment output (if real gene IDs are used):
  - `results/expression/go_enrichment_BP.tsv` – enriched GO BP terms.  
  - `results/expression/go_bp_barplot.png` – visualisation of top GO terms.  
  - With placeholder gene names, the script reports that no terms could be mapped.

- Report (`results/reports/patient_001_report.md`):
  - Phenotype summary.  
  - Bulleted list of top candidate variants with their consequences, allele frequencies and scores.  
  - Expression summary based on DESeq2 results (baseMean and log2 fold changes).  
  - Either:
    - a concise LLM-written narrative (if `OPENAI_API_KEY` is configured), or  
    - a template-based report that still clearly summarises the evidence.

## Discussion

This repository demonstrates how a junior bioinformatician can:

- Build a coherent multi-omics pipeline across Python and R.  
- Use DESeq2 and clusterProfiler for RNA-seq and enrichment analysis.  
- Implement transparent, rule-based variant prioritisation.  
- Integrate a large language model as a reporting layer on top of classical bioinformatics.  

Key design principles include:

- Separation of concerns:
  - Python for variant logic, orchestration and LLM integration.  
  - R for statistical modelling and enrichment using Bioconductor tools.  

- File-based interfaces:
  - Intermediate outputs (variants, expression, enrichment) are saved under `results/` so they can be inspected or reused.

- Safe fallbacks:
  - The pipeline still works without an API key or mappable gene IDs, making it robust for demonstration and teaching.

Potential future extensions:

- Swapping in a small public RNA-seq dataset with real gene symbols to enable meaningful GO enrichment.  
- Adding a more advanced variant classifier (e.g. a simple ML model trained on ClinVar-like data).  
- Logging metrics (e.g. number of DE genes, variant score distributions) for more systematic evaluation.  
- Adding a small web UI (e.g. Streamlit) for uploading inputs and downloading the report.

Overall, this project serves as a realistic, multi-language demonstration of bioinformatics and AI skills relevant to rare disease and pharma workflows.

